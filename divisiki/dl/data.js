////////////////////////////////////////////////////////////////////////////////
// Copyright (C) Alexander Iurovetski 2024
// All rights reserved under MIT license (see LICENSE file)
//
// Manage application data and preferences
////////////////////////////////////////////////////////////////////////////////

"use strict";

////////////////////////////////////////////////////////////////////////////////

class DataClass {
  constructor(that) {
    // Initialize constants
    //
    if (that) {
      return this.init(that.text, that.listNo, that.search, that.isChanged);
    }

    this.appName = "divisiki";
    this.version = "0.1.0";

    this.keyPref = this.appName;

    // Initialize the properties
    //
    this.initUsers();
  }

  //////////////////////////////////////////////////////////////////////////////
  // Delete all saved data and initialize
  //////////////////////////////////////////////////////////////////////////////

  drop() {
    delete localStorage[this.keyPref];
    initUsers();
  }

  //////////////////////////////////////////////////////////////////////////////
  // Delete all users and add the default one
  //////////////////////////////////////////////////////////////////////////////

  initUsers() {
    this.users = new UsersClass();
  }

  //////////////////////////////////////////////////////////////////////////////
  // Load preferences from the local storage, parse those and return this obj
  //////////////////////////////////////////////////////////////////////////////

  load() {
    var prefContent = localStorage[this.keyPref];

    if (prefContent) {
      var pref = Json.fromString(prefContent);
      this.users.fromSerializable(pref.users);
    } else {
      this.save(true);
    }

    return this;
  }

  //////////////////////////////////////////////////////////////////////////////
  // Save preferences to the local storage as a JSON string
  //////////////////////////////////////////////////////////////////////////////

  save(canSave) {
    // If no actual save required, return
    //
    if ((canSave !== undefined) && !canSave) {
      return;
    }

    // Collect all properties that are supposed to be saved
    //
    var pref = {
      version: this.version,
      users: this.users.toSerializable()
    };

    // Write to the local storage
    //

    localStorage[this.keyPref] = Json.toString(pref);
  }

  //////////////////////////////////////////////////////////////////////////////
  // Set the current user's level
  //////////////////////////////////////////////////////////////////////////////

  setLevel(number) {
    this.users.active.active.level(number.length);
  }

  //////////////////////////////////////////////////////////////////////////////
}